import os
from flask import Flask, render_template, request, make_response

app = Flask(__name__)

@app.route('/', methods=['GET', 'POST', 'HEAD'])
def index():
    # 1. Render Health Check Fix (HEAD error ko khatam karta hai)
    if request.method == 'HEAD':
        return make_response('', 200)

    result_data = None
    
    # 2. Market Analysis Logic (POST)
    if request.method == 'POST':
        try:
            p_name = request.form.get('product', '')
            p_price = request.form.get('price', '0')
            
            if p_name and p_price:
                price_val = float(p_price)
                
                # IndiaMART Simulation: Wholesale price usually 50-60% of retail
                wholesale = price_val * 0.55
                profit = price_val - wholesale
                
                # Google Trends Simulation
                trend = "ðŸ”¥ High Demand" if price_val < 1500 else "ðŸ’Ž Premium Niche"
                
                result_data = {
                    "name": p_name,
                    "price": price_val,
                    "wholesale": round(wholesale, 2),
                    "margin": round(profit, 2),
                    "trends": trend,
                    "source": "IndiaMART & Trends Analysis"
                }
        except Exception as e:
            print(f"Error: {e}")
            result_data = {"error": "Please enter a valid price."}

    # 3. Page Loading (GET)
    # Yahan 'index.html' hona chahiye jo templates folder mein hai
    return render_template('index.html', result=result_data)

if __name__ == '__main__':
    port = int(os.environ.get('PORT', 5000))
    app.run(host='0.0.0.0', port=port)
